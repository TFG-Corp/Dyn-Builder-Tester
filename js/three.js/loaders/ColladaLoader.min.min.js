THREE.ColladaLoader=function(e){this.manager=e!==undefined?e:THREE.DefaultLoadingManager};THREE.ColladaLoader.prototype={constructor:THREE.ColladaLoader,crossOrigin:"anonymous",load:function(e,r,t,a){var n=this;var i=n.path===undefined?THREE.LoaderUtils.extractUrlBase(e):n.path;var s=new THREE.FileLoader(n.manager);s.setPath(n.path);s.load(e,function(e){r(n.parse(e,i))},t,a)},setPath:function(e){this.path=e;return this},setResourcePath:function(e){this.resourcePath=e;return this},options:{set convertUpAxis(e){console.warn("THREE.ColladaLoader: options.convertUpAxis() has been removed. Up axis is converted automatically.")}},setCrossOrigin:function(e){this.crossOrigin=e;return this},parse:function(e,r){function t(e,r){var t=[];var a=e.childNodes;for(var n=0,i=a.length;n<i;n++){var s=a[n];if(s.nodeName===r){t.push(s)}}return t}function a(e){if(e.length===0)return[];var r=e.trim().split(/\s+/);var t=new Array(r.length);for(var a=0,n=r.length;a<n;a++){t[a]=r[a]}return t}function n(e){if(e.length===0)return[];var r=e.trim().split(/\s+/);var t=new Array(r.length);for(var a=0,n=r.length;a<n;a++){t[a]=parseFloat(r[a])}return t}function i(e){if(e.length===0)return[];var r=e.trim().split(/\s+/);var t=new Array(r.length);for(var a=0,n=r.length;a<n;a++){t[a]=parseInt(r[a])}return t}function s(e){return e.substring(1)}function o(){return"three_default_"+kr++}function c(e){return Object.keys(e).length===0}function l(e){return{unit:u(t(e,"unit")[0]),upAxis:d(t(e,"up_axis")[0])}}function u(e){if(e!==undefined&&e.hasAttribute("meter")===true){return parseFloat(e.getAttribute("meter"))}else{return 1}}function d(e){return e!==undefined?e.textContent:"Y_UP"}function f(e,r,a,n){var i=t(e,r)[0];if(i!==undefined){var s=t(i,a);for(var o=0;o<s.length;o++){n(s[o])}}}function v(e,r){for(var t in e){var a=e[t];a.build=r(e[t])}}function h(e,r){if(e.build!==undefined)return e.build;e.build=r(e);return e.build}function m(e){var r={sources:{},samplers:{},channels:{}};for(var t=0,a=e.childNodes.length;t<a;t++){var n=e.childNodes[t];if(n.nodeType!==1)continue;var i;switch(n.nodeName){case"source":i=n.getAttribute("id");r.sources[i]=ke(n);break;case"sampler":i=n.getAttribute("id");r.samplers[i]=p(n);break;case"channel":i=n.getAttribute("target");r.channels[i]=b(n);break;default:console.log(n)}}Nr.animations[e.getAttribute("id")]=r}function p(e){var r={inputs:{}};for(var t=0,a=e.childNodes.length;t<a;t++){var n=e.childNodes[t];if(n.nodeType!==1)continue;switch(n.nodeName){case"input":var i=s(n.getAttribute("source"));var o=n.getAttribute("semantic");r.inputs[o]=i;break}}return r}function b(e){var r={};var t=e.getAttribute("target");var a=t.split("/");var n=a.shift();var i=a.shift();var o=i.indexOf("(")!==-1;var c=i.indexOf(".")!==-1;if(c){a=i.split(".");i=a.shift();r.member=a.shift()}else if(o){var l=i.split("(");i=l.shift();for(var u=0;u<l.length;u++){l[u]=parseInt(l[u].replace(/\)/,""))}r.indices=l}r.id=n;r.sid=i;r.arraySyntax=o;r.memberSyntax=c;r.sampler=s(e.getAttribute("source"));return r}function g(e){var r=[];var t=e.channels;var a=e.samplers;var n=e.sources;for(var i in t){if(t.hasOwnProperty(i)){var s=t[i];var o=a[s.sampler];var c=o.inputs.INPUT;var l=o.inputs.OUTPUT;var u=n[c];var d=n[l];var f=E(s,u,d);x(f,r)}}return r}function y(e){return h(Nr.animations[e],g)}function E(e,r,t){var a=Nr.nodes[e.id];var n=sr(a.id);var i=a.transforms[e.sid];var s=a.matrix.clone().transpose();var o,c;var l,u,d,f;var v={};switch(i){case"matrix":for(l=0,u=r.array.length;l<u;l++){o=r.array[l];c=l*t.stride;if(v[o]===undefined)v[o]={};if(e.arraySyntax===true){var h=t.array[c];var m=e.indices[0]+4*e.indices[1];v[o][m]=h}else{for(d=0,f=t.stride;d<f;d++){v[o][d]=t.array[c+d]}}}break;case"translate":console.warn('THREE.ColladaLoader: Animation transform type "%s" not yet implemented.',i);break;case"rotate":console.warn('THREE.ColladaLoader: Animation transform type "%s" not yet implemented.',i);break;case"scale":console.warn('THREE.ColladaLoader: Animation transform type "%s" not yet implemented.',i);break}var p=k(v,s);var b={name:n.uuid,keyframes:p};return b}function k(e,r){var t=[];for(var a in e){t.push({time:parseFloat(a),value:e[a]})}t.sort(i);for(var n=0;n<16;n++){A(t,n,r.elements[n])}return t;function i(e,r){return e.time-r.time}}var N=new THREE.Vector3;var T=new THREE.Vector3;var w=new THREE.Quaternion;function x(e,r){var t=e.keyframes;var a=e.name;var n=[];var i=[];var s=[];var o=[];for(var c=0,l=t.length;c<l;c++){var u=t[c];var d=u.time;var f=u.value;Ke.fromArray(f).transpose();Ke.decompose(N,w,T);n.push(d);i.push(N.x,N.y,N.z);s.push(w.x,w.y,w.z,w.w);o.push(T.x,T.y,T.z)}if(i.length>0)r.push(new THREE.VectorKeyframeTrack(a+".position",n,i));if(s.length>0)r.push(new THREE.QuaternionKeyframeTrack(a+".quaternion",n,s));if(o.length>0)r.push(new THREE.VectorKeyframeTrack(a+".scale",n,o));return r}function A(e,r,t){var a;var n=true;var i,s;for(i=0,s=e.length;i<s;i++){a=e[i];if(a.value[r]===undefined){a.value[r]=null}else{n=false}}if(n===true){for(i=0,s=e.length;i<s;i++){a=e[i];a.value[r]=t}}else{R(e,r)}}function R(e,r){var t,a;for(var n=0,i=e.length;n<i;n++){var s=e[n];if(s.value[r]===null){t=H(e,n,r);a=C(e,n,r);if(t===null){s.value[r]=a.value[r];continue}if(a===null){s.value[r]=t.value[r];continue}_(s,t,a,r)}}}function H(e,r,t){while(r>=0){var a=e[r];if(a.value[t]!==null)return a;r--}return null}function C(e,r,t){while(r<e.length){var a=e[r];if(a.value[t]!==null)return a;r++}return null}function _(e,r,t,a){if(t.time-r.time===0){e.value[a]=r.value[a];return}e.value[a]=(e.time-r.time)*(t.value[a]-r.value[a])/(t.time-r.time)+r.value[a]}function M(e){var r={name:e.getAttribute("id")||"default",start:parseFloat(e.getAttribute("start")||0),end:parseFloat(e.getAttribute("end")||0),animations:[]};for(var t=0,a=e.childNodes.length;t<a;t++){var n=e.childNodes[t];if(n.nodeType!==1)continue;switch(n.nodeName){case"instance_animation":r.animations.push(s(n.getAttribute("url")));break}}Nr.clips[e.getAttribute("id")]=r}function L(e){var r=[];var t=e.name;var a=e.end-e.start||-1;var n=e.animations;for(var i=0,s=n.length;i<s;i++){var o=y(n[i]);for(var c=0,l=o.length;c<l;c++){r.push(o[c])}}return new THREE.AnimationClip(t,a,r)}function O(e){return h(Nr.clips[e],L)}function j(e){var r={};for(var t=0,a=e.childNodes.length;t<a;t++){var n=e.childNodes[t];if(n.nodeType!==1)continue;switch(n.nodeName){case"skin":r.id=s(n.getAttribute("source"));r.skin=I(n);break;case"morph":r.id=s(n.getAttribute("source"));console.warn("THREE.ColladaLoader: Morph target animation not supported yet.");break}}Nr.controllers[e.getAttribute("id")]=r}function I(e){var r={sources:{}};for(var t=0,a=e.childNodes.length;t<a;t++){var i=e.childNodes[t];if(i.nodeType!==1)continue;switch(i.nodeName){case"bind_shape_matrix":r.bindShapeMatrix=n(i.textContent);break;case"source":var s=i.getAttribute("id");r.sources[s]=ke(i);break;case"joints":r.joints=q(i);break;case"vertex_weights":r.vertexWeights=S(i);break}}return r}function q(e){var r={inputs:{}};for(var t=0,a=e.childNodes.length;t<a;t++){var n=e.childNodes[t];if(n.nodeType!==1)continue;switch(n.nodeName){case"input":var i=n.getAttribute("semantic");var o=s(n.getAttribute("source"));r.inputs[i]=o;break}}return r}function S(e){var r={inputs:{}};for(var t=0,a=e.childNodes.length;t<a;t++){var n=e.childNodes[t];if(n.nodeType!==1)continue;switch(n.nodeName){case"input":var o=n.getAttribute("semantic");var c=s(n.getAttribute("source"));var l=parseInt(n.getAttribute("offset"));r.inputs[o]={id:c,offset:l};break;case"vcount":r.vcount=i(n.textContent);break;case"v":r.v=i(n.textContent);break}}return r}function U(e){var r={id:e.id};var t=Nr.geometries[r.id];if(e.skin!==undefined){r.skin=F(e.skin);t.sources.skinIndices=r.skin.indices;t.sources.skinWeights=r.skin.weights}return r}function F(e){var r=4;var t={joints:[],indices:{array:[],stride:r},weights:{array:[],stride:r}};var a=e.sources;var n=e.vertexWeights;var i=n.vcount;var s=n.v;var o=n.inputs.JOINT.offset;var c=n.inputs.WEIGHT.offset;var l=e.sources[e.joints.inputs.JOINT];var u=e.sources[e.joints.inputs.INV_BIND_MATRIX];var d=a[n.inputs.WEIGHT.id].array;var f=0;var v,h,m;for(v=0,m=i.length;v<m;v++){var p=i[v];var b=[];for(h=0;h<p;h++){var g=s[f+o];var y=s[f+c];var E=d[y];b.push({index:g,weight:E});f+=2}b.sort(w);for(h=0;h<r;h++){var k=b[h];if(k!==undefined){t.indices.array.push(k.index);t.weights.array.push(k.weight)}else{t.indices.array.push(0);t.weights.array.push(0)}}}if(e.bindShapeMatrix){t.bindMatrix=(new THREE.Matrix4).fromArray(e.bindShapeMatrix).transpose()}else{t.bindMatrix=(new THREE.Matrix4).identity()}for(v=0,m=l.array.length;v<m;v++){var N=l.array[v];var T=(new THREE.Matrix4).fromArray(u.array,v*u.stride).transpose();t.joints.push({name:N,boneInverse:T})}return t;function w(e,r){return r.weight-e.weight}}function B(e){return h(Nr.controllers[e],U)}function P(e){var r={init_from:t(e,"init_from")[0].textContent};Nr.images[e.getAttribute("id")]=r}function V(e){if(e.build!==undefined)return e.build;return e.init_from}function D(e){var r=Nr.images[e];if(r!==undefined){return h(r,V)}console.warn("THREE.ColladaLoader: Couldn't find image with ID:",e);return null}function z(e){var r={};for(var t=0,a=e.childNodes.length;t<a;t++){var n=e.childNodes[t];if(n.nodeType!==1)continue;switch(n.nodeName){case"profile_COMMON":r.profile=W(n);break}}Nr.effects[e.getAttribute("id")]=r}function W(e){var r={surfaces:{},samplers:{}};for(var t=0,a=e.childNodes.length;t<a;t++){var n=e.childNodes[t];if(n.nodeType!==1)continue;switch(n.nodeName){case"newparam":G(n,r);break;case"technique":r.technique=K(n);break;case"extra":r.extra=re(n);break}}return r}function G(e,r){var t=e.getAttribute("sid");for(var a=0,n=e.childNodes.length;a<n;a++){var i=e.childNodes[a];if(i.nodeType!==1)continue;switch(i.nodeName){case"surface":r.surfaces[t]=J(i);break;case"sampler2D":r.samplers[t]=X(i);break}}}function J(e){var r={};for(var t=0,a=e.childNodes.length;t<a;t++){var n=e.childNodes[t];if(n.nodeType!==1)continue;switch(n.nodeName){case"init_from":r.init_from=n.textContent;break}}return r}function X(e){var r={};for(var t=0,a=e.childNodes.length;t<a;t++){var n=e.childNodes[t];if(n.nodeType!==1)continue;switch(n.nodeName){case"source":r.source=n.textContent;break}}return r}function K(e){var r={};for(var t=0,a=e.childNodes.length;t<a;t++){var n=e.childNodes[t];if(n.nodeType!==1)continue;switch(n.nodeName){case"constant":case"lambert":case"blinn":case"phong":r.type=n.nodeName;r.parameters=Z(n);break}}return r}function Z(e){var r={};for(var t=0,a=e.childNodes.length;t<a;t++){var n=e.childNodes[t];if(n.nodeType!==1)continue;switch(n.nodeName){case"emission":case"diffuse":case"specular":case"bump":case"ambient":case"shininess":case"transparency":r[n.nodeName]=Q(n);break;case"transparent":r[n.nodeName]={opaque:n.getAttribute("opaque"),data:Q(n)};break}}return r}function Q(e){var r={};for(var t=0,a=e.childNodes.length;t<a;t++){var i=e.childNodes[t];if(i.nodeType!==1)continue;switch(i.nodeName){case"color":r[i.nodeName]=n(i.textContent);break;case"float":r[i.nodeName]=parseFloat(i.textContent);break;case"texture":r[i.nodeName]={id:i.getAttribute("texture"),extra:Y(i)};break}}return r}function Y(e){var r={technique:{}};for(var t=0,a=e.childNodes.length;t<a;t++){var n=e.childNodes[t];if(n.nodeType!==1)continue;switch(n.nodeName){case"extra":$(n,r);break}}return r}function $(e,r){for(var t=0,a=e.childNodes.length;t<a;t++){var n=e.childNodes[t];if(n.nodeType!==1)continue;switch(n.nodeName){case"technique":ee(n,r);break}}}function ee(e,r){for(var t=0,a=e.childNodes.length;t<a;t++){var n=e.childNodes[t];if(n.nodeType!==1)continue;switch(n.nodeName){case"repeatU":case"repeatV":case"offsetU":case"offsetV":r.technique[n.nodeName]=parseFloat(n.textContent);break;case"wrapU":case"wrapV":if(n.textContent.toUpperCase()==="TRUE"){r.technique[n.nodeName]=1}else if(n.textContent.toUpperCase()==="FALSE"){r.technique[n.nodeName]=0}else{r.technique[n.nodeName]=parseInt(n.textContent)}break}}}function re(e){var r={};for(var t=0,a=e.childNodes.length;t<a;t++){var n=e.childNodes[t];if(n.nodeType!==1)continue;switch(n.nodeName){case"technique":r.technique=te(n);break}}return r}function te(e){var r={};for(var t=0,a=e.childNodes.length;t<a;t++){var n=e.childNodes[t];if(n.nodeType!==1)continue;switch(n.nodeName){case"double_sided":r[n.nodeName]=parseInt(n.textContent);break}}return r}function ae(e){return e}function ne(e){return h(Nr.effects[e],ae)}function ie(e){var r={name:e.getAttribute("name")};for(var t=0,a=e.childNodes.length;t<a;t++){var n=e.childNodes[t];if(n.nodeType!==1)continue;switch(n.nodeName){case"instance_effect":r.url=s(n.getAttribute("url"));break}}Nr.materials[e.getAttribute("id")]=r}function se(e){var r;var t=e.slice((e.lastIndexOf(".")-1>>>0)+2);t=t.toLowerCase();switch(t){case"tga":r=gr;break;default:r=br}return r}function oe(e){var r=ne(e.url);var t=r.profile.technique;var a=r.profile.extra;var n;switch(t.type){case"phong":case"blinn":n=new THREE.MeshPhongMaterial;break;case"lambert":n=new THREE.MeshLambertMaterial;break;default:n=new THREE.MeshBasicMaterial;break}n.name=e.name||"";function i(e){var t=r.profile.samplers[e.id];var a=null;if(t!==undefined){var n=r.profile.surfaces[t.source];a=D(n.init_from)}else{console.warn("THREE.ColladaLoader: Undefined sampler. Access image directly (see #12530).");a=D(e.id)}if(a!==null){var i=se(a);if(i!==undefined){var s=i.load(a);var o=e.extra;if(o!==undefined&&o.technique!==undefined&&c(o.technique)===false){var l=o.technique;s.wrapS=l.wrapU?THREE.RepeatWrapping:THREE.ClampToEdgeWrapping;s.wrapT=l.wrapV?THREE.RepeatWrapping:THREE.ClampToEdgeWrapping;s.offset.set(l.offsetU||0,l.offsetV||0);s.repeat.set(l.repeatU||1,l.repeatV||1)}else{s.wrapS=THREE.RepeatWrapping;s.wrapT=THREE.RepeatWrapping}return s}else{console.warn("THREE.ColladaLoader: Loader for texture %s not found.",a);return null}}else{console.warn("THREE.ColladaLoader: Couldn't create texture with ID:",e.id);return null}}var s=t.parameters;for(var o in s){var l=s[o];switch(o){case"diffuse":if(l.color)n.color.fromArray(l.color);if(l.texture)n.map=i(l.texture);break;case"specular":if(l.color&&n.specular)n.specular.fromArray(l.color);if(l.texture)n.specularMap=i(l.texture);break;case"bump":if(l.texture)n.normalMap=i(l.texture);break;case"ambient":if(l.texture)n.lightMap=i(l.texture);break;case"shininess":if(l.float&&n.shininess)n.shininess=l.float;break;case"emission":if(l.color&&n.emissive)n.emissive.fromArray(l.color);if(l.texture)n.emissiveMap=i(l.texture);break}}var u=s["transparent"];var d=s["transparency"];if(d===undefined&&u){d={float:1}}if(u===undefined&&d){u={opaque:"A_ONE",data:{color:[1,1,1,1]}}}if(u&&d){if(u.data.texture){n.transparent=true}else{var f=u.data.color;switch(u.opaque){case"A_ONE":n.opacity=f[3]*d.float;break;case"RGB_ZERO":n.opacity=1-f[0]*d.float;break;case"A_ZERO":n.opacity=1-f[3]*d.float;break;case"RGB_ONE":n.opacity=f[0]*d.float;break;default:console.warn('THREE.ColladaLoader: Invalid opaque type "%s" of transparent tag.',u.opaque)}if(n.opacity<1)n.transparent=true}}if(a!==undefined&&a.technique!==undefined&&a.technique.double_sided===1){n.side=THREE.DoubleSide}return n}function ce(e){return h(Nr.materials[e],oe)}function le(e){var r={name:e.getAttribute("name")};for(var t=0,a=e.childNodes.length;t<a;t++){var n=e.childNodes[t];if(n.nodeType!==1)continue;switch(n.nodeName){case"optics":r.optics=ue(n);break}}Nr.cameras[e.getAttribute("id")]=r}function ue(e){for(var r=0;r<e.childNodes.length;r++){var t=e.childNodes[r];switch(t.nodeName){case"technique_common":return de(t)}}return{}}function de(e){var r={};for(var t=0;t<e.childNodes.length;t++){var a=e.childNodes[t];switch(a.nodeName){case"perspective":case"orthographic":r.technique=a.nodeName;r.parameters=fe(a);break}}return r}function fe(e){var r={};for(var t=0;t<e.childNodes.length;t++){var a=e.childNodes[t];switch(a.nodeName){case"xfov":case"yfov":case"xmag":case"ymag":case"znear":case"zfar":case"aspect_ratio":r[a.nodeName]=parseFloat(a.textContent);break}}return r}function ve(e){var r;switch(e.optics.technique){case"perspective":r=new THREE.PerspectiveCamera(e.optics.parameters.yfov,e.optics.parameters.aspect_ratio,e.optics.parameters.znear,e.optics.parameters.zfar);break;case"orthographic":var t=e.optics.parameters.ymag;var a=e.optics.parameters.xmag;var n=e.optics.parameters.aspect_ratio;a=a===undefined?t*n:a;t=t===undefined?a/n:t;a*=.5;t*=.5;r=new THREE.OrthographicCamera(-a,a,t,-t,e.optics.parameters.znear,e.optics.parameters.zfar);break;default:r=new THREE.PerspectiveCamera;break}r.name=e.name||"";return r}function he(e){var r=Nr.cameras[e];if(r!==undefined){return h(r,ve)}console.warn("THREE.ColladaLoader: Couldn't find camera with ID:",e);return null}function me(e){var r={};for(var t=0,a=e.childNodes.length;t<a;t++){var n=e.childNodes[t];if(n.nodeType!==1)continue;switch(n.nodeName){case"technique_common":r=pe(n);break}}Nr.lights[e.getAttribute("id")]=r}function pe(e){var r={};for(var t=0,a=e.childNodes.length;t<a;t++){var n=e.childNodes[t];if(n.nodeType!==1)continue;switch(n.nodeName){case"directional":case"point":case"spot":case"ambient":r.technique=n.nodeName;r.parameters=be(n)}}return r}function be(e){var r={};for(var t=0,a=e.childNodes.length;t<a;t++){var i=e.childNodes[t];if(i.nodeType!==1)continue;switch(i.nodeName){case"color":var s=n(i.textContent);r.color=(new THREE.Color).fromArray(s);break;case"falloff_angle":r.falloffAngle=parseFloat(i.textContent);break;case"quadratic_attenuation":var o=parseFloat(i.textContent);r.distance=o?Math.sqrt(1/o):0;break}}return r}function ge(e){var r;switch(e.technique){case"directional":r=new THREE.DirectionalLight;break;case"point":r=new THREE.PointLight;break;case"spot":r=new THREE.SpotLight;break;case"ambient":r=new THREE.AmbientLight;break}if(e.parameters.color)r.color.copy(e.parameters.color);if(e.parameters.distance)r.distance=e.parameters.distance;return r}function ye(e){var r=Nr.lights[e];if(r!==undefined){return h(r,ge)}console.warn("THREE.ColladaLoader: Couldn't find light with ID:",e);return null}function Ee(e){var r={name:e.getAttribute("name"),sources:{},vertices:{},primitives:[]};var a=t(e,"mesh")[0];if(a===undefined)return;for(var n=0;n<a.childNodes.length;n++){var i=a.childNodes[n];if(i.nodeType!==1)continue;var s=i.getAttribute("id");switch(i.nodeName){case"source":r.sources[s]=ke(i);break;case"vertices":r.vertices=Ne(i);break;case"polygons":console.warn("THREE.ColladaLoader: Unsupported primitive type: ",i.nodeName);break;case"lines":case"linestrips":case"polylist":case"triangles":r.primitives.push(Te(i));break;default:console.log(i)}}Nr.geometries[e.getAttribute("id")]=r}function ke(e){var r={array:[],stride:3};for(var i=0;i<e.childNodes.length;i++){var s=e.childNodes[i];if(s.nodeType!==1)continue;switch(s.nodeName){case"float_array":r.array=n(s.textContent);break;case"Name_array":r.array=a(s.textContent);break;case"technique_common":var o=t(s,"accessor")[0];if(o!==undefined){r.stride=parseInt(o.getAttribute("stride"))}break}}return r}function Ne(e){var r={};for(var t=0;t<e.childNodes.length;t++){var a=e.childNodes[t];if(a.nodeType!==1)continue;r[a.getAttribute("semantic")]=s(a.getAttribute("source"))}return r}function Te(e){var r={type:e.nodeName,material:e.getAttribute("material"),count:parseInt(e.getAttribute("count")),inputs:{},stride:0,hasUV:false};for(var t=0,a=e.childNodes.length;t<a;t++){var n=e.childNodes[t];if(n.nodeType!==1)continue;switch(n.nodeName){case"input":var o=s(n.getAttribute("source"));var c=n.getAttribute("semantic");var l=parseInt(n.getAttribute("offset"));var u=parseInt(n.getAttribute("set"));var d=u>0?c+u:c;r.inputs[d]={id:o,offset:l};r.stride=Math.max(r.stride,l+1);if(c==="TEXCOORD")r.hasUV=true;break;case"vcount":r.vcount=i(n.textContent);break;case"p":r.p=i(n.textContent);break}}return r}function we(e){var r={};for(var t=0;t<e.length;t++){var a=e[t];if(r[a.type]===undefined)r[a.type]=[];r[a.type].push(a)}return r}function xe(e){var r=0;for(var t=0,a=e.length;t<a;t++){var n=e[t];if(n.hasUV===true){r++}}if(r>0&&r<e.length){e.uvsNeedsFix=true}}function Ae(e){var r={};var t=e.sources;var a=e.vertices;var n=e.primitives;if(n.length===0)return{};var i=we(n);for(var s in i){var o=i[s];xe(o);r[s]=Re(o,t,a)}return r}function Re(e,r,t){var a={};var n={array:[],stride:0};var i={array:[],stride:0};var s={array:[],stride:0};var o={array:[],stride:0};var c={array:[],stride:0};var l={array:[],stride:4};var u={array:[],stride:4};var d=new THREE.BufferGeometry;var f=[];var v=0;for(var h=0;h<e.length;h++){var m=e[h];var p=m.inputs;var b=0;switch(m.type){case"lines":case"linestrips":b=m.count*2;break;case"triangles":b=m.count*3;break;case"polylist":for(var g=0;g<m.count;g++){var y=m.vcount[g];switch(y){case 3:b+=3;break;case 4:b+=6;break;default:b+=(y-2)*3;break}}break;default:console.warn("THREE.ColladaLoader: Unknow primitive type:",m.type)}d.addGroup(v,b,h);v+=b;if(m.material){f.push(m.material)}for(var E in p){var k=p[E];switch(E){case"VERTEX":for(var N in t){var T=t[N];switch(N){case"POSITION":var w=n.array.length;He(m,r[T],k.offset,n.array);n.stride=r[T].stride;if(r.skinWeights&&r.skinIndices){He(m,r.skinIndices,k.offset,l.array);He(m,r.skinWeights,k.offset,u.array)}if(m.hasUV===false&&e.uvsNeedsFix===true){var b=(n.array.length-w)/n.stride;for(var x=0;x<b;x++){s.array.push(0,0)}}break;case"NORMAL":He(m,r[T],k.offset,i.array);i.stride=r[T].stride;break;case"COLOR":He(m,r[T],k.offset,c.array);c.stride=r[T].stride;break;case"TEXCOORD":He(m,r[T],k.offset,s.array);s.stride=r[T].stride;break;case"TEXCOORD1":He(m,r[T],k.offset,o.array);s.stride=r[T].stride;break;default:console.warn('THREE.ColladaLoader: Semantic "%s" not handled in geometry build process.',N)}}break;case"NORMAL":He(m,r[k.id],k.offset,i.array);i.stride=r[k.id].stride;break;case"COLOR":He(m,r[k.id],k.offset,c.array);c.stride=r[k.id].stride;break;case"TEXCOORD":He(m,r[k.id],k.offset,s.array);s.stride=r[k.id].stride;break;case"TEXCOORD1":He(m,r[k.id],k.offset,o.array);o.stride=r[k.id].stride;break}}}if(n.array.length>0)d.addAttribute("position",new THREE.Float32BufferAttribute(n.array,n.stride));if(i.array.length>0)d.addAttribute("normal",new THREE.Float32BufferAttribute(i.array,i.stride));if(c.array.length>0)d.addAttribute("color",new THREE.Float32BufferAttribute(c.array,c.stride));if(s.array.length>0)d.addAttribute("uv",new THREE.Float32BufferAttribute(s.array,s.stride));if(o.array.length>0)d.addAttribute("uv2",new THREE.Float32BufferAttribute(o.array,o.stride));if(l.array.length>0)d.addAttribute("skinIndex",new THREE.Float32BufferAttribute(l.array,l.stride));if(u.array.length>0)d.addAttribute("skinWeight",new THREE.Float32BufferAttribute(u.array,u.stride));a.data=d;a.type=e[0].type;a.materialKeys=f;return a}function He(e,r,t,a){var n=e.p;var i=e.stride;var s=e.vcount;function o(e){var r=n[e+t]*l;var i=r+l;for(;r<i;r++){a.push(c[r])}}var c=r.array;var l=r.stride;if(e.vcount!==undefined){var u=0;for(var d=0,f=s.length;d<f;d++){var v=s[d];if(v===4){var h=u+i*0;var m=u+i*1;var p=u+i*2;var b=u+i*3;o(h);o(m);o(b);o(m);o(p);o(b)}else if(v===3){var h=u+i*0;var m=u+i*1;var p=u+i*2;o(h);o(m);o(p)}else if(v>4){for(var g=1,y=v-2;g<=y;g++){var h=u+i*0;var m=u+i*g;var p=u+i*(g+1);o(h);o(m);o(p)}}u+=i*v}}else{for(var d=0,f=n.length;d<f;d+=i){o(d)}}}function Ce(e){return h(Nr.geometries[e],Ae)}function _e(e){var r={name:e.getAttribute("name")||"",joints:{},links:[]};for(var t=0;t<e.childNodes.length;t++){var a=e.childNodes[t];if(a.nodeType!==1)continue;switch(a.nodeName){case"technique_common":Oe(a,r);break}}Nr.kinematicsModels[e.getAttribute("id")]=r}function Me(e){if(e.build!==undefined)return e.build;return e}function Le(e){return h(Nr.kinematicsModels[e],Me)}function Oe(e,r){for(var t=0;t<e.childNodes.length;t++){var a=e.childNodes[t];if(a.nodeType!==1)continue;switch(a.nodeName){case"joint":r.joints[a.getAttribute("sid")]=je(a);break;case"link":r.links.push(qe(a));break}}}function je(e){var r;for(var t=0;t<e.childNodes.length;t++){var a=e.childNodes[t];if(a.nodeType!==1)continue;switch(a.nodeName){case"prismatic":case"revolute":r=Ie(a);break}}return r}function Ie(e,r){var r={sid:e.getAttribute("sid"),name:e.getAttribute("name")||"",axis:new THREE.Vector3,limits:{min:0,max:0},type:e.nodeName,static:false,zeroPosition:0,middlePosition:0};for(var t=0;t<e.childNodes.length;t++){var a=e.childNodes[t];if(a.nodeType!==1)continue;switch(a.nodeName){case"axis":var i=n(a.textContent);r.axis.fromArray(i);break;case"limits":var s=a.getElementsByTagName("max")[0];var o=a.getElementsByTagName("min")[0];r.limits.max=parseFloat(s.textContent);r.limits.min=parseFloat(o.textContent);break}}if(r.limits.min>=r.limits.max){r.static=true}r.middlePosition=(r.limits.min+r.limits.max)/2;return r}function qe(e){var r={sid:e.getAttribute("sid"),name:e.getAttribute("name")||"",attachments:[],transforms:[]};for(var t=0;t<e.childNodes.length;t++){var a=e.childNodes[t];if(a.nodeType!==1)continue;switch(a.nodeName){case"attachment_full":r.attachments.push(Se(a));break;case"matrix":case"translate":case"rotate":r.transforms.push(Ue(a));break}}return r}function Se(e){var r={joint:e.getAttribute("joint").split("/").pop(),transforms:[],links:[]};for(var t=0;t<e.childNodes.length;t++){var a=e.childNodes[t];if(a.nodeType!==1)continue;switch(a.nodeName){case"link":r.links.push(qe(a));break;case"matrix":case"translate":case"rotate":r.transforms.push(Ue(a));break}}return r}function Ue(e){var r={type:e.nodeName};var t=n(e.textContent);switch(r.type){case"matrix":r.obj=new THREE.Matrix4;r.obj.fromArray(t).transpose();break;case"translate":r.obj=new THREE.Vector3;r.obj.fromArray(t);break;case"rotate":r.obj=new THREE.Vector3;r.obj.fromArray(t);r.angle=THREE.Math.degToRad(t[3]);break}return r}function Fe(e){var r={name:e.getAttribute("name")||"",rigidBodies:{}};for(var t=0;t<e.childNodes.length;t++){var a=e.childNodes[t];if(a.nodeType!==1)continue;switch(a.nodeName){case"rigid_body":r.rigidBodies[a.getAttribute("name")]={};Be(a,r.rigidBodies[a.getAttribute("name")]);break}}Nr.physicsModels[e.getAttribute("id")]=r}function Be(e,r){for(var t=0;t<e.childNodes.length;t++){var a=e.childNodes[t];if(a.nodeType!==1)continue;switch(a.nodeName){case"technique_common":Pe(a,r);break}}}function Pe(e,r){for(var t=0;t<e.childNodes.length;t++){var a=e.childNodes[t];if(a.nodeType!==1)continue;switch(a.nodeName){case"inertia":r.inertia=n(a.textContent);break;case"mass":r.mass=n(a.textContent)[0];break}}}function Ve(e){var r={bindJointAxis:[]};for(var t=0;t<e.childNodes.length;t++){var a=e.childNodes[t];if(a.nodeType!==1)continue;switch(a.nodeName){case"bind_joint_axis":r.bindJointAxis.push(De(a));break}}Nr.kinematicsScenes[s(e.getAttribute("url"))]=r}function De(e){var r={target:e.getAttribute("target").split("/").pop()};for(var t=0;t<e.childNodes.length;t++){var a=e.childNodes[t];if(a.nodeType!==1)continue;switch(a.nodeName){case"axis":var n=a.getElementsByTagName("param")[0];r.axis=n.textContent;var i=r.axis.split("inst_").pop().split("axis")[0];r.jointIndex=i.substr(0,i.length-1);break}}return r}function ze(e){if(e.build!==undefined)return e.build;return e}function We(e){return h(Nr.kinematicsScenes[e],ze)}function Ge(){var e=Object.keys(Nr.kinematicsModels)[0];var r=Object.keys(Nr.kinematicsScenes)[0];var t=Object.keys(Nr.visualScenes)[0];if(e===undefined||r===undefined)return;var a=Le(e);var n=We(r);var i=ur(t);var s=n.bindJointAxis;var o={};for(var c=0,l=s.length;c<l;c++){var u=s[c];var d=hr.querySelector('[sid="'+u.target+'"]');if(d){var f=d.parentElement;v(u.jointIndex,f)}}function v(e,r){var t=r.getAttribute("name");var n=a.joints[e];i.traverse(function(a){if(a.name===t){o[e]={object:a,transforms:Je(r),joint:n,position:n.zeroPosition}}})}var h=new THREE.Matrix4;Er={joints:a&&a.joints,getJointValue:function(e){var r=o[e];if(r){return r.position}else{console.warn("THREE.ColladaLoader: Joint "+e+" doesn't exist.")}},setJointValue:function(e,r){var t=o[e];if(t){var a=t.joint;if(r>a.limits.max||r<a.limits.min){console.warn("THREE.ColladaLoader: Joint "+e+" value "+r+" outside of limits (min: "+a.limits.min+", max: "+a.limits.max+").")}else if(a.static){console.warn("THREE.ColladaLoader: Joint "+e+" is static.")}else{var n=t.object;var i=a.axis;var s=t.transforms;Ke.identity();for(var c=0;c<s.length;c++){var l=s[c];if(l.sid&&l.sid.indexOf(e)!==-1){switch(a.type){case"revolute":Ke.multiply(h.makeRotationAxis(i,THREE.Math.degToRad(r)));break;case"prismatic":Ke.multiply(h.makeTranslation(i.x*r,i.y*r,i.z*r));break;default:console.warn("THREE.ColladaLoader: Unknown joint type: "+a.type);break}}else{switch(l.type){case"matrix":Ke.multiply(l.obj);break;case"translate":Ke.multiply(h.makeTranslation(l.obj.x,l.obj.y,l.obj.z));break;case"scale":Ke.scale(l.obj);break;case"rotate":Ke.multiply(h.makeRotationAxis(l.obj,l.angle));break}}}n.matrix.copy(Ke);n.matrix.decompose(n.position,n.quaternion,n.scale);o[e].position=r}}else{console.log("THREE.ColladaLoader: "+e+" does not exist.")}}}}function Je(e){var r=[];var t=hr.querySelector('[id="'+e.id+'"]');for(var a=0;a<t.childNodes.length;a++){var i=t.childNodes[a];if(i.nodeType!==1)continue;switch(i.nodeName){case"matrix":var s=n(i.textContent);var o=(new THREE.Matrix4).fromArray(s).transpose();r.push({sid:i.getAttribute("sid"),type:i.nodeName,obj:o});break;case"translate":case"scale":var s=n(i.textContent);var c=(new THREE.Vector3).fromArray(s);r.push({sid:i.getAttribute("sid"),type:i.nodeName,obj:c});break;case"rotate":var s=n(i.textContent);var c=(new THREE.Vector3).fromArray(s);var l=THREE.Math.degToRad(s[3]);r.push({sid:i.getAttribute("sid"),type:i.nodeName,obj:c,angle:l});break}}return r}function Xe(e){var r=e.getElementsByTagName("node");for(var t=0;t<r.length;t++){var a=r[t];if(a.hasAttribute("id")===false){a.setAttribute("id",o())}}}var Ke=new THREE.Matrix4;var Ze=new THREE.Vector3;function Qe(e){var r={name:e.getAttribute("name")||"",type:e.getAttribute("type"),id:e.getAttribute("id"),sid:e.getAttribute("sid"),matrix:new THREE.Matrix4,nodes:[],instanceCameras:[],instanceControllers:[],instanceLights:[],instanceGeometries:[],instanceNodes:[],transforms:{}};for(var t=0;t<e.childNodes.length;t++){var a=e.childNodes[t];if(a.nodeType!==1)continue;switch(a.nodeName){case"node":r.nodes.push(a.getAttribute("id"));Qe(a);break;case"instance_camera":r.instanceCameras.push(s(a.getAttribute("url")));break;case"instance_controller":r.instanceControllers.push(Ye(a));break;case"instance_light":r.instanceLights.push(s(a.getAttribute("url")));break;case"instance_geometry":r.instanceGeometries.push(Ye(a));break;case"instance_node":r.instanceNodes.push(s(a.getAttribute("url")));break;case"matrix":var i=n(a.textContent);r.matrix.multiply(Ke.fromArray(i).transpose());r.transforms[a.getAttribute("sid")]=a.nodeName;break;case"translate":var i=n(a.textContent);Ze.fromArray(i);r.matrix.multiply(Ke.makeTranslation(Ze.x,Ze.y,Ze.z));r.transforms[a.getAttribute("sid")]=a.nodeName;break;case"rotate":var i=n(a.textContent);var o=THREE.Math.degToRad(i[3]);r.matrix.multiply(Ke.makeRotationAxis(Ze.fromArray(i),o));r.transforms[a.getAttribute("sid")]=a.nodeName;break;case"scale":var i=n(a.textContent);r.matrix.scale(Ze.fromArray(i));r.transforms[a.getAttribute("sid")]=a.nodeName;break;case"extra":break;default:console.log(a)}}if(ir(r.id)){console.warn("THREE.ColladaLoader: There is already a node with ID %s. Exclude current node from further processing.",r.id)}else{Nr.nodes[r.id]=r}return r}function Ye(e){var r={id:s(e.getAttribute("url")),materials:{},skeletons:[]};for(var t=0;t<e.childNodes.length;t++){var a=e.childNodes[t];switch(a.nodeName){case"bind_material":var n=a.getElementsByTagName("instance_material");for(var i=0;i<n.length;i++){var o=n[i];var c=o.getAttribute("symbol");var l=o.getAttribute("target");r.materials[c]=s(l)}break;case"skeleton":r.skeletons.push(s(a.textContent));break;default:break}}return r}function $e(e,r){var t=[];var a=[];var n,i,s;for(n=0;n<e.length;n++){var o=e[n];var c;if(ir(o)){c=sr(o);er(c,r,t)}else if(lr(o)){var l=Nr.visualScenes[o];var u=l.children;for(var i=0;i<u.length;i++){var d=u[i];if(d.type==="JOINT"){var c=sr(d.id);er(c,r,t)}}}else{console.error("THREE.ColladaLoader: Unable to find root bone of skeleton with ID:",o)}}for(n=0;n<r.length;n++){for(i=0;i<t.length;i++){s=t[i];if(s.bone.name===r[n].name){a[n]=s;s.processed=true;break}}}for(n=0;n<t.length;n++){s=t[n];if(s.processed===false){a.push(s);s.processed=true}}var f=[];var v=[];for(n=0;n<a.length;n++){s=a[n];f.push(s.bone);v.push(s.boneInverse)}return new THREE.Skeleton(f,v)}function er(e,r,t){e.traverse(function(e){if(e.isBone===true){var a;for(var n=0;n<r.length;n++){var i=r[n];if(i.name===e.name){a=i.boneInverse;break}}if(a===undefined){a=new THREE.Matrix4}t.push({bone:e,boneInverse:a,processed:false})}})}function rr(e){var r=[];var t=e.matrix;var a=e.nodes;var n=e.type;var i=e.instanceCameras;var s=e.instanceControllers;var o=e.instanceLights;var c=e.instanceGeometries;var l=e.instanceNodes;for(var u=0,d=a.length;u<d;u++){r.push(sr(a[u]))}for(var u=0,d=i.length;u<d;u++){var f=he(i[u]);if(f!==null){r.push(f.clone())}}for(var u=0,d=s.length;u<d;u++){var v=s[u];var h=B(v.id);var m=Ce(h.id);var p=nr(m,v.materials);var b=v.skeletons;var g=h.skin.joints;var y=$e(b,g);for(var E=0,k=p.length;E<k;E++){var N=p[E];if(N.isSkinnedMesh){N.bind(y,h.skin.bindMatrix);N.normalizeSkinWeights()}r.push(N)}}for(var u=0,d=o.length;u<d;u++){var T=ye(o[u]);if(T!==null){r.push(T.clone())}}for(var u=0,d=c.length;u<d;u++){var v=c[u];var m=Ce(v.id);var p=nr(m,v.materials);for(var E=0,k=p.length;E<k;E++){r.push(p[E])}}for(var u=0,d=l.length;u<d;u++){r.push(sr(l[u]).clone())}var N;if(a.length===0&&r.length===1){N=r[0]}else{N=n==="JOINT"?new THREE.Bone:new THREE.Group;for(var u=0;u<r.length;u++){N.add(r[u])}}if(N.name===""){N.name=n==="JOINT"?e.sid:e.name}N.matrix.copy(t);N.matrix.decompose(N.position,N.quaternion,N.scale);return N}var tr=new THREE.MeshBasicMaterial({color:16711935});function ar(e,r){var t=[];for(var a=0,n=e.length;a<n;a++){var i=r[e[a]];if(i===undefined){console.warn("THREE.ColladaLoader: Material with key %s not found. Apply fallback material.",e[a]);t.push(tr)}else{t.push(ce(i))}}return t}function nr(e,r){var t=[];for(var a in e){var n=e[a];var i=ar(n.materialKeys,r);if(i.length===0){if(a==="lines"||a==="linestrips"){i.push(new THREE.LineBasicMaterial)}else{i.push(new THREE.MeshPhongMaterial)}}var s=n.data.attributes.skinIndex!==undefined;if(s){for(var o=0,c=i.length;o<c;o++){i[o].skinning=true}}var l=i.length===1?i[0]:i;var u;switch(a){case"lines":u=new THREE.LineSegments(n.data,l);break;case"linestrips":u=new THREE.Line(n.data,l);break;case"triangles":case"polylist":if(s){u=new THREE.SkinnedMesh(n.data,l)}else{u=new THREE.Mesh(n.data,l)}break}t.push(u)}return t}function ir(e){return Nr.nodes[e]!==undefined}function sr(e){return h(Nr.nodes[e],rr)}function or(e){var r={name:e.getAttribute("name"),children:[]};Xe(e);var a=t(e,"node");for(var n=0;n<a.length;n++){r.children.push(Qe(a[n]))}Nr.visualScenes[e.getAttribute("id")]=r}function cr(e){var r=new THREE.Group;r.name=e.name;var t=e.children;for(var a=0;a<t.length;a++){var n=t[a];r.add(sr(n.id))}return r}function lr(e){return Nr.visualScenes[e]!==undefined}function ur(e){return h(Nr.visualScenes[e],cr)}function dr(e){var r=t(e,"instance_visual_scene")[0];return ur(s(r.getAttribute("url")))}function fr(){var e=Nr.clips;if(c(e)===true){if(c(Nr.animations)===false){var r=[];for(var t in Nr.animations){var a=y(t);for(var n=0,i=a.length;n<i;n++){r.push(a[n])}}yr.push(new THREE.AnimationClip("default",-1,r))}}else{for(var t in e){yr.push(O(t))}}}if(e.length===0){return{scene:new THREE.Scene}}var vr=(new DOMParser).parseFromString(e,"application/xml");var hr=t(vr,"COLLADA")[0];var mr=hr.getAttribute("version");console.log("THREE.ColladaLoader: File version",mr);var pr=l(t(hr,"asset")[0]);var br=new THREE.TextureLoader(this.manager);br.setPath(this.resourcePath||r).setCrossOrigin(this.crossOrigin);var gr;if(THREE.TGALoader){gr=new THREE.TGALoader(this.manager);gr.setPath(this.resourcePath||r)}var yr=[];var Er={};var kr=0;var Nr={animations:{},clips:{},controllers:{},images:{},effects:{},materials:{},cameras:{},lights:{},geometries:{},nodes:{},visualScenes:{},kinematicsModels:{},physicsModels:{},kinematicsScenes:{}};f(hr,"library_animations","animation",m);f(hr,"library_animation_clips","animation_clip",M);f(hr,"library_controllers","controller",j);f(hr,"library_images","image",P);f(hr,"library_effects","effect",z);f(hr,"library_materials","material",ie);f(hr,"library_cameras","camera",le);f(hr,"library_lights","light",me);f(hr,"library_geometries","geometry",Ee);f(hr,"library_nodes","node",Qe);f(hr,"library_visual_scenes","visual_scene",or);f(hr,"library_kinematics_models","kinematics_model",_e);f(hr,"library_physics_models","physics_model",Fe);f(hr,"scene","instance_kinematics_scene",Ve);v(Nr.animations,g);v(Nr.clips,L);v(Nr.controllers,U);v(Nr.images,V);v(Nr.effects,ae);v(Nr.materials,oe);v(Nr.cameras,ve);v(Nr.lights,ge);v(Nr.geometries,Ae);v(Nr.visualScenes,cr);fr();Ge();var Tr=dr(t(hr,"scene")[0]);if(pr.upAxis==="Z_UP"){Tr.quaternion.setFromEuler(new THREE.Euler(-Math.PI/2,0,0))}Tr.scale.multiplyScalar(pr.unit);return{animations:yr,kinematics:Er,library:Nr,scene:Tr}}};
//# sourceMappingURL=ColladaLoader.min.min.js.map